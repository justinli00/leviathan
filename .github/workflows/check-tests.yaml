#check svn for head revision #; compare with working copy revision and run tests for all between
name: check-tests

on:
  #schedule:
    #- cron: '0 * * * *' #runs every hour on the dot
  repository_dispatch:
    types: check
  push: #TODO -- remove

permissions:
  contents: write

jobs:
  check-head:
    runs-on: [self-hosted]
    env:
      SVN_USERNAME: ${{ secrets.svn_username }}
      SVN_PASSWORD: ${{ secrets.svn_password }}
    steps:
    - name: get-revisions
      run: |
        if ( Test-Path -Path svn-repo )
        {
          cd svn-repo
          "SVN_WORKING_REVISION=$(svn info --username $env:SVN_USERNAME --password $env:SVN_PASSWORD --show-item revision)"  | Out-File -FilePath $env:GITHUB_ENV -Append
          "SVN_HEAD_REVISION=$(svn info --username $env:SVN_USERNAME --password $env:SVN_PASSWORD --revision HEAD --show-item revision)" | Out-File -FilePath $env:GITHUB_ENV -Append
          cd ..
        }

    - name: check-revisions
      id: check-revisions
      if: ${{ env.SVN_WORKING_REVISION }} != ${{ env.SVN_HEAD_REVISION }}
      run: |
        Write-Host "Checking updates in the range of [$env:SVN_WORKING_REVISION, $env:SVN_HEAD_REVISION]."
        cd svn-repo
        $revisions_to_test = @()
        $head = [int]$env:SVN_HEAD_REVISION   
        for (($i = [int]$env:SVN_WORKING_REVISION); $i -le $head; $i++)
        {
          #get the change log for revision i and remove all dashes
          $revision_changes = (svn --username $env:SVN_USERNAME --password $env:SVN_PASSWORD log -v -r $i)
          $change_count = ($revision_changes.Split("`n").Count - 1)
          Write-Host "Revision $i contains the following changes : "
          Write-Host "$revision_changes"
          Write-Host "there are $change_count changes."
          if ( $change_count )
          {
            Write-Host "Revision $i contains the following changes to 375_PROJECT : "
            Write-Host "Adding to list of revisions to test."
            $revisions_to_test += ,$i
          }
          else
          {
            Write-Host "Revision $i did not change 375_PROJECT."
          }
        }

        #writing to GITHUB_OUTPUT, not GITHUB_ENV!
        $revisions_to_test = "[" + ([string]$revisions_to_test).Replace(' ', ',') + "]"
        Write-Host "`n--------------------------------`n`nRevisions to test: $revisions_to_test"
        Write-Host $env:GITHUB_OUTPUT
        Write-Host "test_array=$revisions_to_test"
        "test_array=$revisions_to_test" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        #echo "test_array=$revisions_to_test" >> $env:GITHUB_OUTPUT
      shell: powershell
    outputs:
      revisions_to_test: ${{ steps.check-revisions.outputs.test_array }}
  job2:
    runs-on: [self-hosted]
    needs: check-head
    steps:
      - env:
          OUTPUT1: ${{needs.check-head.outputs.revisions_to_test}}
        run: Write-Host "$env:OUTPUT1"

  run-tests:
    if: ${{ needs.check-head.outputs.REVISIONS_TO_TEST }} != $null
    runs-on: [self-hosted]
    needs: check-head
    strategy:
      matrix:
        revision: ${{ needs.check-head.outputs.REVISIONS_TO_TEST }}
    #note - replace with actual workflow run
    steps:
    - name: call-workflow
      uses: ./.github/workflows/input-test.yaml
      with:
        revision: ${{ matrix.revision }}

  #TODO -- just run pull-svn if no revisions are needed
  #update-to-head:
  #  if: ${{ needs.check-head.outputs.REVISIONS_TO_TEST }} == $null
  #  uses: ./.github/workflows/pull-svn.yaml
  #  secrets: inherit
  #  permissions: 
  #    contents: write