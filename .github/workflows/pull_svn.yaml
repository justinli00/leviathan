#updates git repo's versions of svn repo files
name: Pull SVN

on:
  repository_dispatch:
    types: pull-svn
permissions:
  contents: write

jobs:
  pull-svn-files:
    runs-on: ubuntu-latest
    steps:
    - name: checkout-git
      uses: actions/checkout@v3

    #check out or update svn
    #TODO -- not sure if conflicts will actually get resolved -- only time will tell i guess?
    - name: checkout-svn
      run: |
        if [ ! -d svn-repo ];
        then
          echo ">> svn-repo not found. Checking out new copy."
          svn checkout --username $SVN_USERNAME --password $SVN_PASSWORD $SVN_URL svn-repo
        else
          echo ">> svn-repo found. Checking if update is necessary."

          cd svn-repo
          svn info --username $SVN_USERNAME --password $SVN_PASSWORD --show-item revision
          echo "hahahaha----"
          echo "SVN_WORKING_REVISION=$(svn info --username $SVN_USERNAME --password $SVN_PASSWORD --show-item revision)" >> $GITHUB_ENV
          echo "Working revision is ${{ env.SVN_WORKING_REVISION }}"
          echo "SVN_HEAD_REVISION=$(svn info --username $SVN_USERNAME --password $SVN_PASSWORD --revision HEAD --show-item revision)" >> $GITHUB_ENV
          echo "Head revision is ${{ env.SVN_HEAD_REVISION}}"
          
          if [ ${{ env.SVN_WORKING_REVISION }} == ${{ env.SVN_HEAD_REVISION }} ];
          then
            echo ">> Update is not necessary."
            echo "NEED_UPDATE='false'" >> $GITHUB_ENV
            exit
          fi

          echo ">> Update is necessary."

          svn update --username $SVN_USERNAME --password $SVN_PASSWORD 
          echo ">> Update successful. Resolving any conflicts."
          svn resolve --accept theirs-full
          cd ..
        fi
        echo ">> git repo's copy of svn files is now up-to-date."
      shell: bash
      env:
        SVN_USERNAME: ${{ secrets.svn_username }}
        SVN_PASSWORD: ${{ secrets.svn_password }}
        SVN_URL: ${{ secrets.svn_url }}

    #TODO -- add version for the revision to add to the commit message
    #push changes to github
    - name: push-changes
      run: |
        if [ 1 == 2 ]; #[ ${{ env.NEED_UPDATE }} == 'true' ];
        then
          git config user.name '$(git log -n 1 --pretty=format:%an)'
          git config user.email '$(git log -n 1 --pretty=format:%ae)'
          git add .
          git commit -m 'Updating svn to r.$HEAD_REVISION'
          git push
        fi
      shell: bash